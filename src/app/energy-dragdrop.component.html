<div class="container">
  <h2>Arraste os eletrodom√©sticos para o ret√¢ngulo</h2>

  <div class="global-settings">
    <div class="state-selector">
      <label for="state">Selecione o Estado:</label>
      <select
        id="state"
        [(ngModel)]="selectedState"
        (change)="updateTariffFromState()"
      >
        <option *ngFor="let state of states" [value]="state.code">
          {{ state.name }}
        </option>
      </select>
    </div>
    <div class="tariff-input">
      <label for="tariff">Tarifa (R$/kWh):</label>
      <input
        id="tariff"
        type="number"
        [(ngModel)]="globalTariff"
        (input)="recalculate()"
      />
    </div>
  </div>

  <div class="state-selector">
    <p class="simple-text">
      *Lembre-se que isto √© uma estimativa. Para maior precis√£o, confirme a
      tarifa da sua regi√£o.
    </p>
  </div>

  <div class="gallery">
    <div
      *ngFor="let key of applianceKeys"
      class="appliance"
      draggable="true"
      (dragstart)="onDragStart($event, key)"
    >
      <img [src]="appliances[key].image" [alt]="appliances[key].label" />
      <p>{{ appliances[key].label }}</p>
    </div>

    <!-- Add button in the gallery -->
    <div class="appliance add-appliance-button" (click)="openAddDialog()">
      <img
        src="https://cdn-icons-png.flaticon.com/512/1828/1828926.png"
        alt="Adicionar"
      />
      <p>Adicionar</p>
    </div>
  </div>

  <div
    class="dropzone"
    (dragover)="$event.preventDefault()"
    (drop)="onDrop($event)"
  >
    <ng-container *ngIf="selectedAppliances.length === 0">
      <p>Arraste aqui</p>
    </ng-container>

    <div *ngFor="let key of selectedAppliances" class="preview-area">
      <img [src]="appliances[key].image" [alt]="appliances[key].label" />
      <div class="info">
        <p>
          <strong>{{ appliances[key].label }}</strong>
        </p>

        <p>
          <strong>Quantidade:</strong>
          <select
            class="quantity-selector"
            [(ngModel)]="usage[key].quantity"
            (change)="recalculate()"
          >
            <option
              *ngFor="let i of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]"
              [value]="i"
            >
              {{ i }}
            </option>
          </select>
        </p>

        <p>
          <strong>Pot√™ncia (W):</strong>
          <input
            type="number"
            [(ngModel)]="usage[key].powerW"
            (input)="recalculate()"
          />
          W
        </p>

        <div class="all-day-checkbox">
          <label>
            <input
              type="checkbox"
              [(ngModel)]="usage[key].allDay"
              (change)="toggleAllDay(key)"
            />
            <span>Dia todo (24h)</span>
          </label>
        </div>

        <div class="time-input-container" *ngIf="!usage[key].allDay">
          <div class="time-mode-switch">
            <button
              class="switch-btn"
              [class.active]="usage[key].useMinutes"
              (click)="toggleTimeMode(key)"
            >
              Min
            </button>
            <button
              class="switch-btn"
              [class.active]="!usage[key].useMinutes"
              (click)="toggleTimeMode(key)"
            >
              Horas
            </button>
          </div>

          <p>
            <strong>Uso por dia:</strong>
            <input
              type="number"
              [value]="getDisplayValue(key)"
              (input)="updateTimeValue(key, +$any($event.target).value)"
              [step]="usage[key].useMinutes ? 1 : 0.5"
            />
            {{ usage[key].useMinutes ? "min/dia" : "h/dia" }}
          </p>

          <p class="hour-display" *ngIf="usage[key].useMinutes">
            Equivale a:
            {{ getMinutesAsHours(usage[key].minutesPerDay) }} horas/dia
          </p>
        </div>

        <div class="all-day-display" *ngIf="usage[key].allDay">
          <p class="all-day-text">‚è∞ Funcionando 24 horas por dia</p>
        </div>

        <button class="btn-remove" (click)="removeAppliance(key)">
          Remover
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="selectedAppliances.length > 0" class="charts">
    <h3>Consumo de Energia e Custo</h3>
    <canvas
      baseChart
      [data]="barChartData"
      [options]="barChartOptions"
      [type]="'bar'"
      style="width: 100%; max-width: 900px; height: 450px"
    >
    </canvas>

    <div class="insights-container">
      <div class="insight-card">
        <h3>üîã Consumo Total</h3>
        <p>{{ consumoTotal }} kWh/semana</p>
        <small
          >Soma do consumo de todos os seus aparelhos no per√≠odo de uma
          semana.</small
        >
      </div>
      <div class="insight-card">
        <h3>üí° Mais Econ√¥mico</h3>
        <p>{{ maisEconomico.nome }}</p>
        <small>O aparelho que menos consumiu energia na √∫ltima semana.</small>
      </div>
      <div class="insight-card">
        <h3>üìâ M√©dia por Aparelho</h3>
        <p>{{ mediaConsumo }} kWh</p>
        <small
          >O consumo m√©dio de energia para cada tipo de aparelho listado.</small
        >
      </div>
      <div class="insight-card">
        <h3>üí∞ Custo M√©dio Di√°rio</h3>
        <p>R$ {{ mediaDiaria }}</p>
        <small
          >Uma estimativa de quanto voc√™ gasta com energia por dia, com base nos
          aparelhos selecionados.</small
        >
      </div>
      <div class="insight-card">
        <h3>üèÜ Ranking de Consumo</h3>
        <ol>
          <li *ngFor="let item of ranking">
            {{ item.nome }}: {{ item.valor }} kWh
          </li>
        </ol>
        <small
          >Os aparelhos ordenados do maior para o menor consumidor de energia
          semanal.</small
        >
      </div>
      <div class="insight-card">
        <h3>üìä Participa√ß√£o no Consumo</h3>
        <ul>
          <li *ngFor="let item of participacao">
            {{ item.nome }}: {{ item.porcentagem }}%
          </li>
        </ul>
        <small
          >A porcentagem que cada aparelho representa no seu consumo total de
          energia.</small
        >
      </div>
      <div class="insight-card">
        <h3>üìä Variabilidade (Desvio Padr√£o)</h3>
        <p>{{ desvioPadraoConsumo }} kWh</p>
        <small
          >Indica a dispers√£o do consumo entre os aparelhos. Um valor alto
          significa que alguns gastam muito mais que a m√©dia.</small
        >
      </div>
      <div class="insight-card">
        <h3>üìÜ Proje√ß√£o Mensal (Estimativa)</h3>
        <p>R$ {{ projecaoMensal }}</p>
        <small *ngIf="selectedAppliances.length > 1">
          Com 95% de confian√ßa, seu gasto ficar√° entre
          <strong>R$ {{ projecaoMensalMin }}</strong> e
          <strong>R$ {{ projecaoMensalMax }}</strong
          >.
        </small>
        <small *ngIf="selectedAppliances.length <= 1">
          Estimativa de custo para um per√≠odo de 30 dias com base nos dados
          fornecidos.
        </small>
      </div>
    </div>

    <div *ngIf="savingsTips.length > 0" class="tips-container">
      <h3>üí° Dicas de Economia Personalizadas</h3>
      <ul>
        <li *ngFor="let tip of savingsTips">{{ tip }}</li>
      </ul>
    </div>
  </div>

  <!-- Modal for adding custom appliance -->
  <div *ngIf="showAddDialog" class="modal-overlay" (click)="closeAddDialog()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Adicionar Aparelho Personalizado</h3>

      <div class="form-group">
        <label for="customName">Nome do Aparelho:</label>
        <input
          id="customName"
          type="text"
          [(ngModel)]="customApplianceName"
          placeholder="Ex: Secador de Cabelo"
        />
      </div>

      <div class="form-group">
        <label for="customWatts">Pot√™ncia (Watts):</label>
        <input
          id="customWatts"
          type="number"
          [(ngModel)]="customApplianceWatts"
          placeholder="Ex: 1500"
          min="0"
        />
      </div>

      <div class="form-group">
        <label for="customMinutes">Minutos de uso por dia:</label>
        <input
          id="customMinutes"
          type="number"
          [(ngModel)]="customApplianceMinutes"
          placeholder="Ex: 120"
          min="0"
        />
      </div>

      <div class="modal-buttons">
        <button class="btn-cancel" (click)="closeAddDialog()">Cancelar</button>
        <button class="btn-add" (click)="addCustomAppliance()">
          Adicionar
        </button>
      </div>
    </div>
  </div>
</div>
