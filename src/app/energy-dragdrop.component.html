<div class="container">
  <h2>Arraste os eletrodomésticos para o retângulo</h2>

  <!-- Dropdown de Estados -->
  <div class="state-selector">
    <label for="state">Selecione o Estado:</label>
    <select id="state" [(ngModel)]="selectedState" (change)="updateTarifa()">
      <option *ngFor="let state of states" [value]="state.code">{{ state.name }}</option>
    </select>
  </div>

  <!-- Texto básico -->
  <div class="state-selector">
    <p class="simple-text">*lembrando que isso é uma estimativa, para melhor precisão confirme a tarifa da sua região</p>
  </div>

  <!-- Galeria -->
  <div class="gallery">
    <div *ngFor="let key of applianceKeys" class="appliance" draggable="true"
         (dragstart)="onDragStart($event,key)">
      <img [src]="appliances[key].image" [alt]="appliances[key].label" />
      <p>{{ appliances[key].label }}</p>
    </div>
  </div>

  <!-- Área de drop -->
  <div class="dropzone" (dragover)="$event.preventDefault()" (drop)="onDrop($event)">
    <ng-container *ngIf="selectedAppliances.length === 0">
      <p>Arraste aqui</p>
    </ng-container>

    <div *ngFor="let key of selectedAppliances" class="preview-area">
      <img [src]="appliances[key].image" [alt]="appliances[key].label" />
      <div class="info">
        <p><strong>{{ appliances[key].label }}</strong></p>
        <p><strong>Potência (W):</strong>
          <input type="number" [(ngModel)]="usage[key].powerW" (input)="recalculate()" /> W
        </p>
        <p><strong>Uso por dia:</strong>
          <input type="number" [(ngModel)]="usage[key].hoursPerDay" (input)="recalculate()" /> horas/dia
        </p>
        <p><strong>Tarifa / kWh:</strong>
          <input type="number" [(ngModel)]="usage[key].costPerKwh" (input)="recalculate()" /> BRL
        </p>
        <button (click)="removeAppliance(key)">Remover</button>
      </div>
    </div>
  </div>

  <!-- Gráfico e insights -->
  <div *ngIf="selectedAppliances.length > 0" class="charts">
    <h3>Consumo de Energia e Custo</h3>
    <canvas baseChart
      [data]="barChartData"
      [options]="barChartOptions"
      [type]="'bar'"
      style="width: 100%; max-width: 900px; height: 450px;">
    </canvas>

    <div class="insights-container">
      <div class="insight-card">
        <h3>🔋 Consumo total</h3>
        <p>{{ consumoTotal }} kWh/semana</p>
      </div>
      <div class="insight-card">
        <h3>💡 Mais econômico</h3>
        <p>{{ maisEconomico.nome }} - {{ maisEconomico.valor }} kWh</p>
      </div>
      <div class="insight-card">
        <h3>📉 Média por aparelho</h3>
        <p>{{ mediaConsumo }} kWh</p>
      </div>
      <div class="insight-card">
        <h3>📊 Participação</h3>
        <ul>
          <li *ngFor="let item of participacao">{{ item.nome }}: {{ item.porcentagem }}%</li>
        </ul>
      </div>
      <div class="insight-card">
        <h3>💰 Média diária</h3>
        <p>R$ {{ mediaDiaria }}</p>
      </div>
      <div class="insight-card">
        <h3>📆 Projeção mensal</h3>
        <p>R$ {{ projecaoMensal }}</p>
      </div>
      <div class="insight-card">
        <h3>⚖️ Diferença</h3>
        <p>R$ {{ diferenca }}</p>
      </div>
      <div class="insight-card">
        <h3>🏆 Ranking</h3>
        <ol>
          <li *ngFor="let item of ranking">{{ item.nome }} - {{ item.valor }} kWh</li>
        </ol>
      </div>
      <div class="insight-card">
        <h3>💡 Economia possível</h3>
        <p>Desligar {{ maiorGastao.nome }} 1h → economiza {{ economia }} kWh</p>
      </div>
      <div class="insight-card">
        <h3>⏱️ Consumo/hora</h3>
        <p>{{ consumoPorHora }} kWh</p>
      </div>
      <div class="insight-card">
        <h3>📊 Variabilidade (Desvio Padrão)</h3>
        <p>{{ desvioPadraoConsumo }} kWh</p>
        <small>Indica a dispersão do consumo entre os aparelhos. Um valor alto significa que alguns aparelhos gastam muito mais que a média.</small>
      </div>
      <div class="insight-card">
        <h3>📆 Projeção Mensal (Estimativa)</h3>
        <p>R$ {{ projecaoMensal }}</p>
        <small *ngIf="selectedAppliances.length > 1">
          Com 95% de confiança, seu gasto ficará entre <strong>R$ {{ projecaoMensalMin }}</strong> e <strong>R$ {{ projecaoMensalMax }}</strong>.
        </small>
      </div>
      <div *ngIf="savingsTips.length > 0" class="tips-container">
        <h3>💡 Dicas de Economia Personalizadas</h3>
        <ul>
          <li *ngFor="let tip of savingsTips">{{ tip }}</li>
        </ul>
      </div>
    </div>
  </div>
</div>
